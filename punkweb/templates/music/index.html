{% extends 'punkweb/base.html' %}
{% load static bbcode_tags thumbnail %}

{% block title %}Music{% endblock %}

{% block main %}
<div class="main" style="margin-bottom: 140px;">
  <h1>Music</h1>
  <h3>Artists</h3>
  <div class="tableContainer">
    <table>
      <thead>
        <tr>
          <th width="75px">Artist</th>
          <th></th>
          <th>Genre</th>
        </tr>
      </thead>
      <tbody>
        {% for artist in artists %}
        <tr>
          <td>
            <img src="{{artist.image|thumbnail_url:'avatar_smaller'}}" alt="" />
          </td>
          <td>
            {{artist.name}}
          </td>
          <td>
            {{artist.genre}}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <h3>Albums</h3>
  <div class="tableContainer">
    <table>
      <thead>
        <tr>
          <th width="75px">Album</th>
          <th></th>
          <th>Artist</th>
          <th>Year</th>
        </tr>
      </thead>
      <tbody>
        {% for album in albums %}
        <tr>
          <td>
            <img src="{{album.cover_art|thumbnail_url:'avatar_smaller'}}" alt="" />
          </td>
          <td>
            {{album.title}}
          </td>
          <td>{{album.artist.name}}</td>
          <td>{{album.year|date:'Y'}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <h3>Compilations</h3>
  <div class="tableContainer">
    <table>
      <thead>
        <tr>
          <th>
            Name
          </th>
          <th>
            Created
          </th>
          <th>
            Updated
          </th>
        </tr>
      </thead>
      <tbody>
        {% for compilation in compilations %}
        <tr>
          <td>
            <a href="{% url 'music:audio_compilation' compilation.slug %}">{{compilation.title}}</a>
          </td>
          <td>
            {{compilation.created|date:'m/d/Y'}}
          </td>
          <td>
            {{compilation.modified|date:'m/d/Y'}}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <h3>Tracks</h3>
  <div class="tableContainer">
    <table>
      <thead>
        <tr>
          <th>
            Song
          </th>
          <th>
            Artist
          </th>
          <th>
            Album
          </th>
        </tr>
      </thead>
      <tbody>
        {% for track in audio %}
        <tr>
          <td>
            <a class="trackTitle" data-title="{{track.title}}" data-artist-name="{{track.album.artist.name}}" data-art-url="{{track.album.cover_art|thumbnail_url:'avatar_small'}}" data-file="/media/{{track.file}}">{{track.title}}</a>
            <!-- <a href="{% url 'music:audio' track.slug %}">{{track.title}}</a> -->
          </td>
          <td>
            {{track.album.artist.name}}
          </td>
          <td>
            {{track.album.title}}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div class="musicPlayer">
  <div class="musicPlayer__container">
    <div class="musicPlayer__info">
      <div class="musicPlayer__image">
        <img id="songImage" alt="">
      </div>
      <div>
        <div id="songName"></div>
        <div id="artistName"></div>
      </div>
    </div>
    <div class="musicPlayer__controls">
      <div class="musicPlayer__buttons">
        <button class="button" id="play"><i class="fas fa-play"></i></button>
        <button class="button" id="pause"><i class="fas fa-pause"></i></button>
        <button class="button" id="restart"><i class="fas fa-undo"></i></button>
      </div>
      <div class="musicPlayer__timeline">
        <div id="currentTime"></div>
        <div class="musicPlayer__trackerContainer" id="trackerContainer">
          <div id="tracker"></div>
          <div id="tracked"></div>
        </div>
        <div id="totalTime"></div>
      </div>
    </div>
    <div class="musicPlayer__volume">

    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(document).ready(function() {
  var audio = document.createElement('audio');
  var musicPlayer = $('.musicPlayer');
  var songImage = $('#songImage');
  var songName = $('#songName');
  var artistName = $('#artistName')

  $('#currentTime').text('0:00');
  $('#totalTime').text('0:00');

  function timeFormat(time) {
    var hrs = Math.floor(time / 3600);
    var mins = Math.floor(time / 60);
    var secs = Math.floor(time - mins * 60);
    var str = '';

    if (hrs > 0) {
      str += '' + hrs + ":" + (mins < 10 ? '0' : '');
    }

    str += '' + mins + ':' + (secs < 10 ? '0' : '');
    str += '' + secs;
    return str;
  }

  audio.addEventListener('ended', function() {
    this.play();
  }, false);
  audio.addEventListener('canplay', function() { }, false);
  audio.addEventListener('timeupdate', function() {
    $('#currentTime').text(timeFormat(audio.currentTime));
    $('#totalTime').text(timeFormat(audio.duration));
    $('#tracked').width(((audio.currentTime/audio.duration)  * 100) + '%');
  }, false);
  $('#play').click(function() {
    audio.play();
  });
  $('#pause').click(function() {
    audio.pause();
  });
  $('#restart').click(function() {
    audio.currentTime = 0;
  });
  $('.trackTitle').click(function() {
    var self = $(this);
    musicPlayer.show();
    songImage.attr('src', self.attr('data-art-url'));
    songName.text(self.attr('data-title'));
    artistName.text(self.attr('data-artist-name'));
    audio.setAttribute('src', self.attr('data-file'));
    audio.play();
  });
  $('#trackerContainer').click(function(e) {
    var self = $(this);
    var offset = self.offset();
    var x = e.clientX - offset.left;
    var y = e.clientY - offset.top;
    var width = self.width();
    var clickPercent = (x / width);
    var toDuration = audio.duration * clickPercent;
    audio.currentTime = toDuration;
  });
});
</script>
{% endblock %}
